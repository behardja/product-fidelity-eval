import uuid

from google import genai
from google.genai import types
from google.adk.tools.tool_context import ToolContext

from ..config import PROJECT_ID, LOCATION, IMAGE_GEN_MODEL, BUCKET_NAME
from .gcs import write_to_gcs


RECONTEXTUALIZATION_PROMPT = (
    "Using the provided product image, generate a new image of the same product "
    "in a contextually appropriate setting. The new image should NOT have a white "
    "background, and should be contextualized based on the product itself. "
    "For example, if the product is a bag, the image should show the bag in a "
    "natural ad or professional photo setting. If the product is a dress, the "
    "image should show the dress in a natural model photo setting. "
    "If there is a person in the original product image, create a variation "
    "of the person with the product without copying the exact same pose and "
    "environment as in the original image. "
    "Keep the product exactly as it is â€” do not alter its design, colors, "
    "logos, or any visual details."
)


def generate_product_image(tool_context: ToolContext) -> dict:
    """Generate a recontextualized product image from the original product reference image(s).

    Takes the original product reference image(s) from state and places them
    into a contextually appropriate background/setting.

    Returns:
        dict with 'image_uri' containing the GCS URI of the generated image.
    """
    client = genai.Client(
        vertexai=True,
        project=PROJECT_ID,
        location=LOCATION,
        http_options=types.HttpOptions(
            timeout=60 * 1000,
            retry_options=types.HttpRetryOptions(
                attempts=5,
                initial_delay=1.0,
                jitter=0.3,
                max_delay=20.0,
                http_status_codes=[408, 429, 500, 502, 503, 504],
            ),
        ),
    )

    # Build multimodal contents: original product images + recontextualization prompt
    image_uris = tool_context.state.get("image_uris", "")
    uris = [u.strip() for u in image_uris.split(",") if u.strip()]

    content_parts = []
    for uri in uris:
        ext = uri.lower().rsplit(".", 1)[-1]
        mime = "image/jpeg" if ext in ("jpg", "jpeg") else f"image/{ext}"
        content_parts.append(types.Part.from_uri(file_uri=uri, mime_type=mime))

    attempt = tool_context.state.get("attempt", 1)
    if attempt > 1:
        # On retries, augment the prompt with the refined description and
        # the specific attributes that failed so the model can correct them.
        refined = tool_context.state.get("current_description", "")
        failing = tool_context.state.get("failing_verdicts_text", "")
        retry_prompt = (
            f"{RECONTEXTUALIZATION_PROMPT}\n\n"
            f"IMPORTANT: A previous attempt failed fidelity checks. "
            f"Pay extra attention to the following attributes that were NOT "
            f"faithfully reproduced:\n{failing}\n\n"
            f"Use this refined product description as guidance:\n{refined}"
        )
        content_parts.append(retry_prompt)
    else:
        content_parts.append(RECONTEXTUALIZATION_PROMPT)

    response = client.models.generate_content(
        model=IMAGE_GEN_MODEL,
        contents=content_parts,
        config=types.GenerateContentConfig(
            response_modalities=["IMAGE", "TEXT"],
        ),
    )

    for part in response.parts:
        if part.inline_data is not None:
            image_bytes = part.inline_data.data
            sku_id = tool_context.state.get("sku_id", "unknown")
            attempt = tool_context.state.get("attempt", 1)
            image_id = str(uuid.uuid4())[:8]
            gcs_path = (
                f"gs://{BUCKET_NAME}/generated/{sku_id}/"
                f"attempt_{attempt}_{image_id}.png"
            )

            write_to_gcs(image_bytes, gcs_path)
            tool_context.state["candidate_image_uri"] = gcs_path
            return {"status": "success", "image_uri": gcs_path}

    return {"status": "error", "message": "No image was generated by the model."}
