import uuid

from google import genai
from google.genai import types
from google.adk.tools.tool_context import ToolContext

from ..config import PROJECT_ID, LOCATION, IMAGE_GEN_MODEL, BUCKET_NAME
from .gcs import write_to_gcs


def generate_product_image(description: str, tool_context: ToolContext) -> dict:
    """Generate a product image from a text description using Gemini image generation.

    Args:
        description: Text description of the product to generate.

    Returns:
        dict with 'image_uri' containing the GCS URI of the generated image.
    """
    client = genai.Client(vertexai=True, project=PROJECT_ID, location=LOCATION)

    response = client.models.generate_content(
        model=IMAGE_GEN_MODEL,
        contents=description,
        config=types.GenerateContentConfig(
            response_modalities=["IMAGE", "TEXT"],
        ),
    )

    for part in response.parts:
        if part.inline_data is not None:
            image_bytes = part.inline_data.data
            sku_id = tool_context.state.get("sku_id", "unknown")
            attempt = tool_context.state.get("attempt", 1)
            image_id = str(uuid.uuid4())[:8]
            gcs_path = (
                f"gs://{BUCKET_NAME}/generated/{sku_id}/"
                f"attempt_{attempt}_{image_id}.png"
            )

            write_to_gcs(image_bytes, gcs_path)
            tool_context.state["candidate_image_uri"] = gcs_path
            return {"status": "success", "image_uri": gcs_path}

    return {"status": "error", "message": "No image was generated by the model."}
